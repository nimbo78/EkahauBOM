# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Excel —ç–∫—Å–ø–æ—Ä—Ç–∞ (Iteration 2)

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2025-10-24
## –í–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∞: 2.2
## –°—Ç–∞—Ç—É—Å: üéØ –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô

---

## –¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏

–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Excel —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Å—Ç–∞–º–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏ –∏ –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏–∑ v2.1.0.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã (Worksheets)
- **Summary** - –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
- **Access Points** - –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –¥–æ—Å—Ç—É–ø–∞ —Å —Ç–µ–≥–∞–º–∏
- **Antennas** - –¢–∞–±–ª–∏—Ü–∞ –∞–Ω—Ç–µ–Ω–Ω
- **By Floor** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —ç—Ç–∞–∂–∞–º
- **By Color** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–≤–µ—Ç–∞–º
- **By Vendor** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–µ–Ω–¥–æ—Ä–∞–º
- **By Model** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º
- **By Tag** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–µ–≥—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 2. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å —Ü–≤–µ—Ç–æ–º –∏ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
- –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (freeze panes)
- –ê–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- –ì—Ä–∞–Ω–∏—Ü—ã —è—á–µ–µ–∫
- –£—Å–ª–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ü–≤–µ—Ç–æ–≤ AP

### 3. –î–∏–∞–≥—Ä–∞–º–º—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- Pie chart: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–µ–Ω–¥–æ—Ä–∞–º
- Bar chart: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ AP –ø–æ —ç—Ç–∞–∂–∞–º
- Bar chart: –¢–æ–ø 10 –º–æ–¥–µ–ª–µ–π
- Bar chart: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ü–≤–µ—Ç–∞–º

### 4. CLI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –ê—Ä–≥—É–º–µ–Ω—Ç `--format` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: `csv`, `excel`, `csv,excel`

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –î–µ–Ω—å 1: –ë–∞–∑–æ–≤—ã–π Excel —ç–∫—Å–ø–æ—Ä—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 1.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–§–∞–π–ª:** `requirements.txt`

–î–æ–±–∞–≤–∏—Ç—å:
```
openpyxl>=3.1.0
```

**–í—ã–±–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
- **openpyxl** - –æ—Ç–ª–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–∏–∞–≥—Ä–∞–º–º, –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: xlsxwriter (–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –Ω–µ —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã)

#### 1.2 –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π Excel —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä

**–§–∞–π–ª:** `ekahau_bom/exporters/excel_exporter.py`

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""Excel exporter with advanced formatting and charts."""

import logging
from pathlib import Path
from collections import Counter

from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils import get_column_letter
from openpyxl.chart import PieChart, BarChart, Reference

from .base import BaseExporter
from ..models import ProjectData, AccessPoint, Antenna

logger = logging.getLogger(__name__)


class ExcelExporter(BaseExporter):
    """Export project data to Excel files with formatting and charts.

    Creates Excel workbook with multiple sheets:
    - Summary: Project overview and statistics
    - Access Points: Detailed AP list with tags
    - Antennas: Antenna list
    - By Floor: Grouped by floor
    - By Color: Grouped by color
    - By Vendor: Grouped by vendor
    - By Model: Grouped by model
    """

    @property
    def format_name(self) -> str:
        """Human-readable name of the export format."""
        return "Excel"

    def export(self, project_data: ProjectData) -> list[Path]:
        """Export project data to Excel file.

        Args:
            project_data: Processed project data to export

        Returns:
            List with single Excel file path

        Raises:
            IOError: If file writing fails
        """
        output_file = self._get_output_filename(
            project_data.project_name,
            f"{project_data.project_name}.xlsx"
        )

        # Create workbook
        wb = Workbook()

        # Remove default sheet
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])

        # Create sheets
        self._create_summary_sheet(wb, project_data)
        self._create_access_points_sheet(wb, project_data.access_points)
        self._create_antennas_sheet(wb, project_data.antennas)
        self._create_grouped_sheets(wb, project_data.access_points)

        # Save workbook
        wb.save(output_file)

        logger.info(f"Excel file created: {output_file}")
        self.log_export_success([output_file])

        return [output_file]
```

#### 1.3 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –≤ ExcelExporter:

```python
    # –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    HEADER_FONT = Font(bold=True, color="FFFFFF", size=11)
    HEADER_FILL = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
    HEADER_ALIGNMENT = Alignment(horizontal="center", vertical="center")

    # –ì—Ä–∞–Ω–∏—Ü—ã
    THIN_BORDER = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )

    def _apply_header_style(self, ws, row: int = 1):
        """Apply header style to first row."""
        for cell in ws[row]:
            cell.font = self.HEADER_FONT
            cell.fill = self.HEADER_FILL
            cell.alignment = self.HEADER_ALIGNMENT
            cell.border = self.THIN_BORDER

    def _auto_size_columns(self, ws):
        """Auto-size all columns based on content."""
        for column in ws.columns:
            max_length = 0
            column_letter = get_column_letter(column[0].column)

            for cell in column:
                try:
                    if cell.value:
                        max_length = max(max_length, len(str(cell.value)))
                except:
                    pass

            adjusted_width = min(max_length + 2, 50)  # Max 50 chars
            ws.column_dimensions[column_letter].width = adjusted_width

    def _apply_autofilter(self, ws):
        """Apply autofilter to the sheet."""
        ws.auto_filter.ref = ws.dimensions

    def _freeze_header(self, ws, row: int = 2):
        """Freeze header row."""
        ws.freeze_panes = ws[f'A{row}']
```

---

### –î–µ–Ω—å 2: –õ–∏—Å—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (Summary, APs, Antennas)

#### 2.1 Summary –ª–∏—Å—Ç

```python
    def _create_summary_sheet(self, wb: Workbook, project_data: ProjectData):
        """Create summary sheet with project statistics."""
        ws = wb.create_sheet("Summary", 0)

        # Project info
        ws['A1'] = "Project Summary"
        ws['A1'].font = Font(bold=True, size=14)

        ws['A3'] = "Project Name:"
        ws['B3'] = project_data.project_name
        ws['A4'] = "Total Access Points:"
        ws['B4'] = len(project_data.access_points)
        ws['A5'] = "Total Antennas:"
        ws['B5'] = len(project_data.antennas)

        # Statistics by vendor
        ws['A7'] = "By Vendor"
        ws['A7'].font = Font(bold=True, size=12)

        vendor_counts = Counter(ap.vendor for ap in project_data.access_points)
        row = 8
        ws['A' + str(row)] = "Vendor"
        ws['B' + str(row)] = "Count"
        self._apply_header_style(ws, row)

        for vendor, count in sorted(vendor_counts.items()):
            row += 1
            ws[f'A{row}'] = vendor
            ws[f'B{row}'] = count

        # Add more statistics...

        self._auto_size_columns(ws)
```

#### 2.2 Access Points –ª–∏—Å—Ç

```python
    def _create_access_points_sheet(self, wb: Workbook, access_points: list[AccessPoint]):
        """Create detailed access points sheet."""
        ws = wb.create_sheet("Access Points")

        # Headers
        headers = ["Vendor", "Model", "Floor", "Color", "Tags", "Quantity"]
        ws.append(headers)
        self._apply_header_style(ws)

        # Group and count APs
        ap_tuples = [
            (ap.vendor, ap.model, ap.floor_name, ap.color,
             frozenset(str(tag) for tag in ap.tags))
            for ap in access_points
        ]
        ap_counts = Counter(ap_tuples)

        # Write data
        for (vendor, model, floor, color, tags), count in sorted(ap_counts.items()):
            tags_str = "; ".join(sorted(tags)) if tags else ""
            ws.append([vendor, model, floor, color or "", tags_str, count])

        # Apply formatting
        self._auto_size_columns(ws)
        self._apply_autofilter(ws)
        self._freeze_header(ws)

        # Apply borders to all cells
        for row in ws.iter_rows(min_row=1, max_row=ws.max_row,
                                min_col=1, max_col=len(headers)):
            for cell in row:
                cell.border = self.THIN_BORDER
```

#### 2.3 Antennas –ª–∏—Å—Ç

```python
    def _create_antennas_sheet(self, wb: Workbook, antennas: list[Antenna]):
        """Create antennas sheet."""
        ws = wb.create_sheet("Antennas")

        # Headers
        headers = ["Antenna Model", "Quantity"]
        ws.append(headers)
        self._apply_header_style(ws)

        # Count antennas
        antenna_names = [antenna.name for antenna in antennas]
        antenna_counts = Counter(antenna_names)

        # Write data
        for antenna_name, count in sorted(antenna_counts.items()):
            ws.append([antenna_name, count])

        # Apply formatting
        self._auto_size_columns(ws)
        self._apply_autofilter(ws)
        self._freeze_header(ws)
```

---

### –î–µ–Ω—å 3: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ (By Floor, By Color, By Vendor, By Model)

#### 3.1 –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤

```python
    def _create_grouped_sheet(
        self,
        wb: Workbook,
        sheet_name: str,
        grouped_data: dict[str, int],
        dimension_name: str
    ):
        """Create a grouped sheet with counts and percentages.

        Args:
            wb: Workbook
            sheet_name: Name of the sheet
            grouped_data: Dictionary with counts by dimension
            dimension_name: Name of the dimension (e.g., "Floor", "Vendor")
        """
        ws = wb.create_sheet(sheet_name)

        # Headers
        headers = [dimension_name, "Count", "Percentage"]
        ws.append(headers)
        self._apply_header_style(ws)

        # Calculate total
        total = sum(grouped_data.values())

        # Write data sorted by count (descending)
        for key, count in sorted(grouped_data.items(), key=lambda x: x[1], reverse=True):
            percentage = (count / total * 100) if total > 0 else 0
            ws.append([key, count, f"{percentage:.1f}%"])

        # Apply formatting
        self._auto_size_columns(ws)
        self._apply_autofilter(ws)
        self._freeze_header(ws)

        # Apply borders
        for row in ws.iter_rows(min_row=1, max_row=ws.max_row, min_col=1, max_col=3):
            for cell in row:
                cell.border = self.THIN_BORDER
```

#### 3.2 –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤

```python
    def _create_grouped_sheets(self, wb: Workbook, access_points: list[AccessPoint]):
        """Create all grouped sheets."""
        from ..analytics import GroupingAnalytics

        analytics = GroupingAnalytics()

        # By Floor
        floor_data = analytics.group_by_floor(access_points)
        self._create_grouped_sheet(wb, "By Floor", floor_data, "Floor")

        # By Color
        color_data = analytics.group_by_color(access_points)
        self._create_grouped_sheet(wb, "By Color", color_data, "Color")

        # By Vendor
        vendor_data = analytics.group_by_vendor(access_points)
        self._create_grouped_sheet(wb, "By Vendor", vendor_data, "Vendor")

        # By Model
        model_data = analytics.group_by_model(access_points)
        self._create_grouped_sheet(wb, "By Model", model_data, "Model")
```

---

### –î–µ–Ω—å 4: –î–∏–∞–≥—Ä–∞–º–º—ã –∏ —É—Å–ª–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 4.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º

```python
    def _add_pie_chart(self, ws, data_range: str, title: str, position: str = "E2"):
        """Add pie chart to worksheet.

        Args:
            ws: Worksheet
            data_range: Range of data (e.g., "A2:B10")
            title: Chart title
            position: Cell position for chart
        """
        chart = PieChart()
        chart.title = title
        chart.style = 10
        chart.height = 10  # default is 7.5
        chart.width = 15   # default is 15

        # Data for chart
        labels = Reference(ws, min_col=1, min_row=2, max_row=ws.max_row)
        data = Reference(ws, min_col=2, min_row=1, max_row=ws.max_row)

        chart.add_data(data, titles_from_data=True)
        chart.set_categories(labels)

        ws.add_chart(chart, position)

    def _add_bar_chart(self, ws, data_range: str, title: str, position: str = "E2"):
        """Add bar chart to worksheet."""
        chart = BarChart()
        chart.type = "col"  # Column chart
        chart.title = title
        chart.style = 10
        chart.height = 10
        chart.width = 15

        # Data for chart
        labels = Reference(ws, min_col=1, min_row=2, max_row=ws.max_row)
        data = Reference(ws, min_col=2, min_row=1, max_row=ws.max_row)

        chart.add_data(data, titles_from_data=True)
        chart.set_categories(labels)

        ws.add_chart(chart, position)
```

#### 4.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º –∫ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–∏—Å—Ç–∞–º

–û–±–Ω–æ–≤–∏—Ç—å `_create_grouped_sheet`:

```python
    def _create_grouped_sheet(
        self,
        wb: Workbook,
        sheet_name: str,
        grouped_data: dict[str, int],
        dimension_name: str,
        add_chart: bool = True
    ):
        """Create a grouped sheet with counts, percentages, and optional chart."""
        ws = wb.create_sheet(sheet_name)

        # ... existing code ...

        # Add chart if requested
        if add_chart and len(grouped_data) > 0:
            if dimension_name == "Vendor":
                self._add_pie_chart(ws, "", f"Distribution by {dimension_name}", "E2")
            else:
                self._add_bar_chart(ws, "", f"Count by {dimension_name}", "E2")
```

#### 4.3 –£—Å–ª–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ü–≤–µ—Ç–æ–≤

```python
    def _apply_conditional_formatting(self, ws, color_column: int = 4):
        """Apply conditional formatting for AP colors.

        Args:
            ws: Worksheet
            color_column: Column number with color data (1-indexed)
        """
        from openpyxl.formatting.rule import Rule
        from openpyxl.styles.differential import DifferentialStyle

        # Color mappings from config
        color_map = {
            "Yellow": "FFE600",
            "Orange": "FF8500",
            "Red": "FF0000",
            "Blue": "0000FF",
            # Add more colors
        }

        for color_name, hex_color in color_map.items():
            fill = PatternFill(start_color=hex_color, end_color=hex_color, fill_type="solid")
            dxf = DifferentialStyle(fill=fill)
            rule = Rule(type="containsText", operator="containsText",
                       text=color_name, dxf=dxf)
            rule.formula = [f'NOT(ISERROR(SEARCH("{color_name}",${get_column_letter(color_column)}2)))']

            ws.conditional_formatting.add(
                f'{get_column_letter(color_column)}2:{get_column_letter(color_column)}{ws.max_row}',
                rule
            )
```

---

### –î–µ–Ω—å 5: CLI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 5.1 –û–±–Ω–æ–≤–∏—Ç—å CLI

**–§–∞–π–ª:** `ekahau_bom/cli.py`

–î–æ–±–∞–≤–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç:

```python
parser.add_argument(
    '--format',
    type=str,
    default='csv',
    help='Export format(s): csv, excel, or csv,excel (default: csv)'
)
```

–û–±–Ω–æ–≤–∏—Ç—å `process_project`:

```python
def process_project(
    esx_file: Path,
    output_dir: Path,
    colors_config: Path | None = None,
    export_formats: list[str] = None,
    # ... other args ...
) -> int:
    # ... existing code ...

    # Default to CSV if no format specified
    if not export_formats:
        export_formats = ['csv']

    # Export to requested formats
    from .exporters.csv_exporter import CSVExporter
    from .exporters.excel_exporter import ExcelExporter

    exporters = {
        'csv': CSVExporter(output_dir),
        'excel': ExcelExporter(output_dir)
    }

    for format_name in export_formats:
        if format_name in exporters:
            exporter = exporters[format_name]
            exporter.export(project_data)
        else:
            logger.warning(f"Unknown export format: {format_name}")
```

#### 5.2 –û–±–Ω–æ–≤–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

```python
def main() -> int:
    # ... existing code ...

    # Parse export formats
    export_formats = [f.strip().lower() for f in parsed_args.format.split(',')]

    return process_project(
        # ... other args ...
        export_formats=export_formats
    )
```

#### 5.3 –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_excel_exporter.py`

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""Unit tests for Excel exporter."""

import pytest
from pathlib import Path
from ekahau_bom.exporters.excel_exporter import ExcelExporter
from ekahau_bom.models import ProjectData, AccessPoint, Antenna, Tag


@pytest.fixture
def sample_project_data():
    """Create sample project data."""
    aps = [
        AccessPoint("Cisco", "AP-515", "Yellow", "Floor 1",
                   tags=[Tag("Location", "Building A", "1")]),
        AccessPoint("Cisco", "AP-635", "Red", "Floor 2", tags=[]),
        AccessPoint("Aruba", "AP-515", "Yellow", "Floor 1", tags=[]),
    ]
    antennas = [
        Antenna("ANT-2513P4M-N-R"),
        Antenna("ANT-2513P4M-N-R"),
    ]
    return ProjectData("Test Project", aps, antennas)


class TestExcelExporter:
    """Test ExcelExporter class."""

    def test_export_creates_file(self, sample_project_data, tmp_path):
        """Test that export creates Excel file."""
        exporter = ExcelExporter(tmp_path)
        files = exporter.export(sample_project_data)

        assert len(files) == 1
        assert files[0].exists()
        assert files[0].suffix == '.xlsx'

    def test_export_has_required_sheets(self, sample_project_data, tmp_path):
        """Test that Excel file has all required sheets."""
        from openpyxl import load_workbook

        exporter = ExcelExporter(tmp_path)
        files = exporter.export(sample_project_data)

        wb = load_workbook(files[0])
        sheet_names = wb.sheetnames

        assert "Summary" in sheet_names
        assert "Access Points" in sheet_names
        assert "Antennas" in sheet_names
        assert "By Floor" in sheet_names
        assert "By Vendor" in sheet_names
```

---

### –î–µ–Ω—å 6-7: –î–æ—Ä–∞–±–æ—Ç–∫–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### 6.1 –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç "By Tag" –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è --group-by tag
- [ ] –£–ª—É—á—à–∏—Ç—å Summary —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ Summary –ª–∏—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (>1000 AP)

#### 6.2 –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**README.md:**

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã:

```bash
# Export to Excel
python EkahauBOM.py project.esx --format excel

# Export to both CSV and Excel
python EkahauBOM.py project.esx --format csv,excel

# Excel with filtering
python EkahauBOM.py project.esx --format excel --filter-vendor "Cisco"
```

#### 6.3 –û–±–Ω–æ–≤–∏—Ç—å requirements.txt

```
PyYAML>=6.0
openpyxl>=3.1.0
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
EkahauBOM/
‚îú‚îÄ‚îÄ ekahau_bom/
‚îÇ   ‚îú‚îÄ‚îÄ exporters/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ csv_exporter.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ excel_exporter.py      # NEW
‚îÇ   ‚îî‚îÄ‚îÄ cli.py                      # UPDATED: --format argument
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_excel_exporter.py     # NEW
‚îú‚îÄ‚îÄ requirements.txt                # UPDATED: +openpyxl
‚îî‚îÄ‚îÄ README.md                       # UPDATED: Excel examples
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤—ã–π Excel —ç–∫—Å–ø–æ—Ä—Ç
```bash
python EkahauBOM.py project.esx --format excel
```

### Excel + CSV
```bash
python EkahauBOM.py project.esx --format csv,excel
```

### Excel —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
```bash
python EkahauBOM.py project.esx \
  --format excel \
  --filter-floor "Floor 1,Floor 2" \
  --filter-vendor "Cisco"
```

### Excel —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
```bash
python EkahauBOM.py project.esx \
  --format excel \
  --group-by vendor \
  --output-dir reports/
```

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ß—Ç–æ —É–∂–µ –µ—Å—Ç—å (v2.1.0):**
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–æ–≤ (BaseExporter)
- ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (GroupingAnalytics)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–≥–æ–≤ –≤ –º–æ–¥–µ–ª—è—Ö
- ‚úÖ CLI –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- [ ] openpyxl –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- [ ] ExcelExporter –∫–ª–∞—Å—Å
- [ ] --format CLI –∞—Ä–≥—É–º–µ–Ω—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GroupingAnalytics
- [ ] Unit —Ç–µ—Å—Ç—ã

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å write_only —Ä–µ–∂–∏–º openpyxl –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–≥—Ä–∞–º–º
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–∏—Å–∫ 2: –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Excel –≤–µ—Ä—Å–∏—è–º–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Excel
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ openpyxl
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞ LibreOffice/Google Sheets

### –†–∏—Å–∫ 3: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ Excel —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ 7+ –ª–∏—Å—Ç–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ –î–∏–∞–≥—Ä–∞–º–º—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –§–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Excel/LibreOffice
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <5 —Å–µ–∫ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Å 500 AP
- ‚úÖ Unit —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ Iteration 2

1. **Iteration 3: HTML –æ—Ç—á–µ—Ç—ã** - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ HTML —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
2. **Iteration 4: JSON —ç–∫—Å–ø–æ—Ä—Ç** - –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
3. **Iteration 5: Advanced Analytics** - –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –º–µ—Ç—Ä–∏–∫–∏

---

**–í–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∞:** 2.2
**–î–∞—Ç–∞:** 2025-10-24
**–°—Ç–∞—Ç—É—Å:** üéØ –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1 –Ω–µ–¥–µ–ª—è (5-7 –¥–Ω–µ–π)
